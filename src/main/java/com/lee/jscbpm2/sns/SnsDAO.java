package com.lee.jscbpm2.sns;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.ibatis.session.SqlSession;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.lee.jscbpm2.member.Member;

@Service
public class SnsDAO {

	@Autowired
	private SqlSession ss;
	
	private int AllSnsCount;
	
	public void write(Sns s, HttpServletRequest req, HttpServletResponse res) {
		try {
			Member m = (Member) req.getSession().getAttribute("loginMember");
			s.setJs_id(m.getJm_id());
			
			s.setJs_txt(s.getJs_txt().replace("\r\n", "<br>"));
			
			if (ss.getMapper(SnsMapper.class).write(s) == 1) {
				req.setAttribute("r", "등록 성공");
				AllSnsCount++;
			}
		} catch (Exception e) {
			req.setAttribute("r", "등록 실패");
			e.printStackTrace();
		}
	}
	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
	public void writeReply(Reply r, HttpServletRequest req, HttpServletResponse res) {
		try {
			Member m = (Member) req.getSession().getAttribute("loginMember");
			r.setJr_id(m.getJm_id());
			
			r.setJr_txt(r.getJr_txt().replace("\r\n", "<br>"));
			
			if (ss.getMapper(SnsMapper.class).writeReply(r) == 1) {
				req.setAttribute("r", "댓글 등록 성공");
			}
		} catch (Exception e) {
			req.setAttribute("r", "댓글 등록 실패");
			e.printStackTrace();
		}
	}
	
	public void getAllSnsCount() {
		AllSnsCount = ss.getMapper(SnsMapper.class).getAllSnsCount();
		System.out.println(AllSnsCount);
	}
	
	public void paging(int pageNo, HttpServletRequest req, HttpServletResponse res) {
		@SuppressWarnings("unchecked")
		List<Sns> searchSnsAl = (List<Sns>) req.getSession().getAttribute("searchSnsAl");
		double count = 8.0;		// 한 페이지당 보여줄 갯수
		req.setAttribute("curPage", pageNo);
		
		try {
			if (searchSnsAl != null && searchSnsAl.size() > 0) {
				// 검색
				int pageCount = (int) Math.ceil(searchSnsAl.size() / count);
				req.setAttribute("pageCount", pageCount);
				
				// 전체 목록 중에서 페이지 번호에 맞는 것만 추줄
				int start = (searchSnsAl.size() - ((pageNo - 1) * (int)count));
				int end = (pageNo == pageCount) ? 1 : (start - ((int)count - 1));	// 마지막 페이지는 무조건 1
			
				ArrayList<Sns> snsAl2 = new ArrayList<Sns>();
				Sns s = null;
				
				for (int i = start-1; i >= end-1; i--) {
					s = searchSnsAl.get(i);
					s.setJs_repls(ss.getMapper(SnsMapper.class).getReply(s));
					snsAl2.add(s);
				}
				req.setAttribute("snsAl", snsAl2);
			} else if (AllSnsCount > 0) {
				// 조회
				// 전체 페이지 수 계산
				int pageCount = (int) Math.ceil(AllSnsCount / count);
				req.setAttribute("pageCount", pageCount);
				
				// 전체 목록 중에서 페이지 번호에 맞는 것만 추줄
				int start = (AllSnsCount - ((pageNo - 1) * (int)count));
				int end = (pageNo == pageCount) ? 1 : (start - ((int)count - 1));	// 마지막 페이지는 무조건 1
			
				SnsNo sn = new SnsNo(new BigDecimal(start), new BigDecimal(end));
				List<Sns> snsAl2 = new ArrayList<Sns>();
				snsAl2 = ss.getMapper(SnsMapper.class).getSns(sn);
				Sns s = null;
				for (int i = 0; i < snsAl2.size(); i++) {
					s = snsAl2.get(i);
					s.setJs_repls(ss.getMapper(SnsMapper.class).getReply(s));
				}
				req.setAttribute("snsAl", snsAl2);
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
	
//			List<Sns> snsAl2 = new ArrayList<>();
//			Sns s = null;
//			List<Reply> repls = null;
//			for (int i = start-1; i >= end-1; i--) {
//				s = pageSns.get(i);
//				
//				try {
//					repls = DBManager.connectMyBatis().selectList("getRepl", s);
//					s.setJs_repls(repls);
//				} catch (IOException e) {
//					e.printStackTrace();
//				}
//				snsAl2.add(s);
	}
	
	public void search(Query q, HttpServletRequest req, HttpServletResponse res) {
		req.getSession().setAttribute("searchSnsAl", ss.getMapper(SnsMapper.class).search(q));
	}
	
	public void clearSearch(HttpServletRequest req, HttpServletResponse res) {
		req.getSession().setAttribute("searchSnsAl", null);
	}
	
	public void update(Sns s, HttpServletRequest req, HttpServletResponse res) {
		try {
			if (ss.getMapper(SnsMapper.class).update(s) == 1) {
				req.setAttribute("r", "수정 성공");
			}
		} catch (Exception e) {
			req.setAttribute("r", "수정 실패");
			e.printStackTrace();
		}
	}
	
	public void updateReply(Reply r, HttpServletRequest req, HttpServletResponse res) {
		try {
			if (ss.getMapper(SnsMapper.class).updateReply(r) == 1) {
				req.setAttribute("r", "수정 성공");
			}
		} catch (Exception e) {
			req.setAttribute("r", "수정 실패");
			e.printStackTrace();
		}
	}
	
	public void delete(Sns s, HttpServletRequest req, HttpServletResponse res) {
		try {
			if (ss.getMapper(SnsMapper.class).delete(s) == 1) {
				req.setAttribute("r", "삭제 성공");
				AllSnsCount--;
			}
		} catch (Exception e) {
			req.setAttribute("r", "삭제 실패");
			e.printStackTrace();
		}
	}
	
	public void deleteReplybyJrno(Reply r, HttpServletRequest req, HttpServletResponse res) {
		try {
			if (ss.getMapper(SnsMapper.class).deleteReplybyJrno(r) == 1) {
				req.setAttribute("r", "삭제 성공");
			}
		} catch (Exception e) {
			req.setAttribute("r", "삭제 실패");
			e.printStackTrace();
		}
	}
}
